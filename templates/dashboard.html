{% extends "base.html" %}

{% block title %}Dashboard - Outlook to Gmail Forwarder{% endblock %}

{% block extra_css %}
<style>
    .stat-icon {
        font-size: 2.5rem;
        opacity: 0.8;
    }
    .scheduler-status {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-primary" onclick="triggerForwarding()">
            <i class="bi bi-play-fill"></i> Forward Now
        </button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row">
    <div class="col-md-3 mb-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-4">
                        <i class="bi bi-people-fill stat-icon text-primary"></i>
                    </div>
                    <div class="col-8 text-end">
                        <h5 class="card-title mb-0">{{ total_accounts }}</h5>
                        <p class="card-text text-muted small">Total Accounts</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-4">
                        <i class="bi bi-check-circle-fill stat-icon text-success"></i>
                    </div>
                    <div class="col-8 text-end">
                        <h5 class="card-title mb-0">{{ active_accounts }}</h5>
                        <p class="card-text text-muted small">Active Accounts</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-4">
                        <i class="bi bi-envelope-check-fill stat-icon text-info"></i>
                    </div>
                    <div class="col-8 text-end">
                        <h5 class="card-title mb-0" id="emails-forwarded">-</h5>
                        <p class="card-text text-muted small">Emails Today</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-4">
                        <i class="bi bi-clock-fill stat-icon text-warning"></i>
                    </div>
                    <div class="col-8 text-end">
                        <h5 class="card-title mb-0" id="next-run">-</h5>
                        <p class="card-text text-muted small">Next Run</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scheduler Status -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Scheduler Status</h5>
            </div>
            <div class="card-body">
                <div class="scheduler-status">
                    <div class="row mb-3">
                        <div class="col-6">Status:</div>
                        <div class="col-6">
                            {% if scheduler_status.is_running %}
                                <span class="badge bg-warning">Running</span>
                            {% elif scheduler_status.is_paused %}
                                <span class="badge bg-secondary">Paused</span>
                            {% else %}
                                <span class="badge bg-success">Active</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">Next Run:</div>
                        <div class="col-6" id="scheduler-next-run">
                            {{ scheduler_status.next_run.strftime('%Y-%m-%d %H:%M') if scheduler_status.next_run else 'N/A' }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            {% if not scheduler_status.is_paused %}
                                <button class="btn btn-sm btn-warning" onclick="pauseScheduler()">
                                    <i class="bi bi-pause-fill"></i> Pause
                                </button>
                            {% else %}
                                <button class="btn btn-sm btn-success" onclick="resumeScheduler()">
                                    <i class="bi bi-play-fill"></i> Resume
                                </button>
                            {% endif %}
                            <button class="btn btn-sm btn-primary" onclick="updateInterval()">
                                <i class="bi bi-gear"></i> Update Interval
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Forwarding Activity</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Jobs -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recent Jobs</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Started</th>
                                <th>Accounts</th>
                                <th>Forwarded</th>
                                <th>Failed</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for job in recent_jobs %}
                            <tr>
                                <td>{{ job.job_type|capitalize }}</td>
                                <td>
                                    {% if job.status == 'completed' %}
                                        <span class="badge bg-success">{{ job.status }}</span>
                                    {% elif job.status == 'running' %}
                                        <span class="badge bg-warning">{{ job.status }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ job.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ job.started_at.strftime('%Y-%m-%d %H:%M') if job.started_at else '-' }}</td>
                                <td>{{ job.processed_accounts }}/{{ job.total_accounts }}</td>
                                <td>{{ job.forwarded_emails }}</td>
                                <td>{{ job.failed_emails }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Forwards -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recent Email Forwards</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Account</th>
                                <th>Subject</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for forward in recent_forwards %}
                            <tr>
                                <td>{{ forward.forwarded_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ forward.account.username }}</td>
                                <td>{{ forward.subject[:50] }}{% if forward.subject|length > 50 %}...{% endif %}</td>
                                <td>
                                    {% if forward.status == 'success' %}
                                        <span class="badge bg-success">Success</span>
                                    {% else %}
                                        <span class="badge bg-danger">Failed</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Load statistics
function loadStats() {
    $.get('/api/stats', function(data) {
        // Update chart
        updateChart(data.daily_stats);
        
        // Update today's count
        if (data.daily_stats.length > 0) {
            const today = data.daily_stats[data.daily_stats.length - 1];
            $('#emails-forwarded').text(today.count);
        }
    });
}

// Update activity chart
function updateChart(dailyStats) {
    const ctx = document.getElementById('activityChart').getContext('2d');
    
    const labels = dailyStats.map(d => d.date);
    const data = dailyStats.map(d => d.count);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Emails Forwarded',
                data: data,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Trigger forwarding
function triggerForwarding() {
    if (confirm('Start email forwarding now?')) {
        $.post('/api/forward/trigger', function(response) {
            if (response.success) {
                alert('Forwarding job started successfully!');
                setTimeout(() => location.reload(), 2000);
            } else {
                alert('Error: ' + response.message);
            }
        });
    }
}

// Pause scheduler
function pauseScheduler() {
    $.post('/api/scheduler/pause', function(response) {
        if (response.success) {
            location.reload();
        }
    });
}

// Resume scheduler
function resumeScheduler() {
    $.post('/api/scheduler/resume', function(response) {
        if (response.success) {
            location.reload();
        }
    });
}

// Update interval
function updateInterval() {
    const minutes = prompt('Enter forwarding interval in minutes:', '30');
    if (minutes && !isNaN(minutes)) {
        $.post('/api/scheduler/update', 
            JSON.stringify({minutes: parseInt(minutes)}),
            function(response) {
                if (response.success) {
                    alert('Interval updated successfully!');
                    location.reload();
                }
            },
            'json'
        ).fail(function() {
            alert('Failed to update interval');
        });
    }
}

// Update next run time
function updateNextRun() {
    const nextRun = $('#scheduler-next-run').text();
    if (nextRun && nextRun !== 'N/A') {
        const nextRunDate = new Date(nextRun);
        const now = new Date();
        const diff = nextRunDate - now;
        
        if (diff > 0) {
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            
            if (hours > 0) {
                $('#next-run').text(`${hours}h ${mins}m`);
            } else {
                $('#next-run').text(`${mins}m`);
            }
        } else {
            $('#next-run').text('Soon');
        }
    }
}

// Initialize
$(document).ready(function() {
    loadStats();
    updateNextRun();
    
    // Update every 30 seconds
    setInterval(function() {
        updateNextRun();
    }, 30000);
});
</script>
{% endblock %} 