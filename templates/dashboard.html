{% extends "base.html" %}

{% block title %}Dashboard - Outlook to Gmail Forwarder{% endblock %}

{% block extra_css %}
<style>
    .stat-icon {
        font-size: 2.5rem;
        opacity: 0.8;
    }
    .scheduler-status {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
    }
    .chart-container {
        position: relative;
        height: 300px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-primary" onclick="triggerForwarding()">
            <i class="bi bi-play-fill"></i> Forward Now
        </button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row">
    <div class="col-md-3 mb-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-4">
                        <i class="bi bi-people-fill stat-icon text-primary"></i>
                    </div>
                    <div class="col-8 text-end">
                        <h5 class="card-title mb-0">{{ total_accounts }}</h5>
                        <p class="card-text text-muted small">Total Accounts</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-4">
                        <i class="bi bi-check-circle-fill stat-icon text-success"></i>
                    </div>
                    <div class="col-8 text-end">
                        <h5 class="card-title mb-0">{{ active_accounts }}</h5>
                        <p class="card-text text-muted small">Active Accounts</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-4">
                        <i class="bi bi-envelope-check-fill stat-icon text-info"></i>
                    </div>
                    <div class="col-8 text-end">
                        <h5 class="card-title mb-0" id="emails-forwarded">-</h5>
                        <p class="card-text text-muted small">Emails Today</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card stat-card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-4">
                        <i class="bi bi-clock-fill stat-icon text-warning"></i>
                    </div>
                    <div class="col-8 text-end">
                        <h5 class="card-title mb-0" id="next-run">-</h5>
                        <p class="card-text text-muted small">Next Run</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scheduler Status -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Scheduler Status</h5>
            </div>
            <div class="card-body">
                <div class="scheduler-status">
                    <div class="row mb-3">
                        <div class="col-6">Status:</div>
                        <div class="col-6">
                            <span id="scheduler-status-badge" class="badge">Loading...</span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">Next Run:</div>
                        <div class="col-6" id="scheduler-next-run">
                            {{ scheduler_status.next_run.strftime('%Y-%m-%d %H:%M') if scheduler_status.next_run else 'N/A' }}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">Interval:</div>
                        <div class="col-6">
                            <span id="scheduler-interval">{{ scheduler_status.interval_minutes or 30 }}</span> minutes
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <button class="btn btn-sm btn-warning" id="scheduler-toggle-btn" onclick="toggleScheduler()" disabled>
                                <i class="bi bi-pause-fill" id="scheduler-toggle-icon"></i> 
                                <span id="scheduler-toggle-text">Loading...</span>
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="updateInterval()">
                                <i class="bi bi-gear"></i> Update Interval
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Forwarding Activity</h5>
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Jobs -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recent Jobs</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Started</th>
                                <th>Accounts</th>
                                <th>Forwarded</th>
                                <th>Failed</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for job in recent_jobs %}
                            <tr>
                                <td>{{ job.job_type|capitalize }}</td>
                                <td>
                                    {% if job.status == 'completed' %}
                                        <span class="badge bg-success">{{ job.status }}</span>
                                    {% elif job.status == 'running' %}
                                        <span class="badge bg-warning">{{ job.status }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ job.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ job.started_at.strftime('%Y-%m-%d %H:%M') if job.started_at else '-' }}</td>
                                <td>{{ job.processed_accounts }}/{{ job.total_accounts }}</td>
                                <td>{{ job.forwarded_emails }}</td>
                                <td>{{ job.failed_emails }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Forwards -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recent Email Forwards</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Account</th>
                                <th>Subject</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for forward in recent_forwards %}
                            <tr>
                                <td>{{ forward.forwarded_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ forward.account.username }}</td>
                                <td>{{ forward.subject[:50] }}{% if forward.subject|length > 50 %}...{% endif %}</td>
                                <td>
                                    {% if forward.status == 'success' %}
                                        <span class="badge bg-success">Success</span>
                                    {% else %}
                                        <span class="badge bg-danger">Failed</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Load statistics
function loadStats() {
    $.get('/api/stats', function(data) {
        // Update chart
        updateChart(data.daily_stats);
        
        // Update today's count
        if (data.daily_stats.length > 0) {
            const today = data.daily_stats[data.daily_stats.length - 1];
            $('#emails-forwarded').text(today.count);
        }
    });
}

// Update activity chart
function updateChart(dailyStats) {
    const ctx = document.getElementById('activityChart').getContext('2d');
    
    const labels = dailyStats.map(d => d.date);
    const data = dailyStats.map(d => d.count);
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Emails Forwarded',
                data: data,
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Trigger forwarding
function triggerForwarding() {
    if (confirm('Start email forwarding now?')) {
        $.post('/api/forward/trigger', function(response) {
            if (response.success) {
                alert('Forwarding job started successfully!');
                setTimeout(() => location.reload(), 2000);
            } else {
                alert('Error: ' + response.message);
            }
        });
    }
}

// Debounce function to prevent double-clicks
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Global state for scheduler
let schedulerState = {
    isToggling: false,
    currentStatus: null
};

// Toggle scheduler with debouncing
const toggleScheduler = debounce(function() {
    if (schedulerState.isToggling) {
        console.log('Toggle already in progress, skipping...');
        return;
    }
    
    schedulerState.isToggling = true;
    const $btn = $('#scheduler-toggle-btn');
    const $icon = $('#scheduler-toggle-icon');
    const $text = $('#scheduler-toggle-text');
    
    // Disable button and show loading state
    $btn.prop('disabled', true);
    $text.text('Processing...');
    
    $.ajax({
        url: '/api/scheduler/toggle',
        method: 'POST',
        success: function(response) {
            if (response.success && response.status) {
                // Update UI based on new status
                updateSchedulerUI(response.status);
                
                // Show success feedback
                const action = response.status.is_paused ? 'paused' : 'resumed';
                console.log(`Scheduler ${action} successfully`);
                
                // Store the new state
                schedulerState.currentStatus = response.status;
            } else {
                console.error('Failed to toggle scheduler');
                alert('Failed to toggle scheduler. Please try again.');
                // Refresh status to ensure UI is in sync
                refreshSchedulerStatus();
            }
        },
        error: function(xhr) {
            console.error('Error toggling scheduler:', xhr);
            alert('Error toggling scheduler. Please check the logs.');
            // Refresh status to ensure UI is in sync
            refreshSchedulerStatus();
        },
        complete: function() {
            schedulerState.isToggling = false;
            $btn.prop('disabled', false);
        }
    });
}, 500); // 500ms debounce delay

// Update interval
function updateInterval() {
    // First, get the current scheduler status to ensure we have accurate interval
    $.get('/api/scheduler/status', function(statusResponse) {
        let currentInterval = '30'; // Default fallback
        
        if (statusResponse.success && statusResponse.status && statusResponse.status.interval_minutes) {
            currentInterval = statusResponse.status.interval_minutes.toString();
        } else {
            // Fallback to reading from DOM if API fails
            const domInterval = $('#scheduler-interval').text();
            if (domInterval && !isNaN(domInterval)) {
                currentInterval = domInterval;
            }
        }
        
        const minutes = prompt(`Enter forwarding interval in minutes (current: ${currentInterval}):`, currentInterval);
        
        if (minutes === null) {
            return; // User cancelled
        }
        
        if (!minutes || isNaN(minutes) || parseInt(minutes) < 1) {
            alert('Please enter a valid number greater than 0');
            return;
        }
        
        const intervalMinutes = parseInt(minutes);
        
        if (intervalMinutes > 10080) {
            alert('Interval cannot exceed 1 week (10080 minutes)');
            return;
        }
        
        // Show loading state
        const originalText = $('#scheduler-interval').text();
        $('#scheduler-interval').text('Updating...');
        
        $.ajax({
            url: '/api/scheduler/update',
            method: 'POST',
            data: JSON.stringify({minutes: intervalMinutes}),
            contentType: 'application/json',
            success: function(response) {
                if (response.success) {
                    alert(`Interval updated successfully to ${intervalMinutes} minutes!`);
                    
                    // Update the display immediately
                    $('#scheduler-interval').text(intervalMinutes);
                    
                    // Reload page to refresh all scheduler info
                    setTimeout(() => location.reload(), 1000);
                } else {
                    alert(`Failed to update interval: ${response.message || 'Unknown error'}`);
                    $('#scheduler-interval').text(originalText);
                }
            },
            error: function(xhr) {
                let errorMessage = 'Failed to update interval';
                try {
                    const response = JSON.parse(xhr.responseText);
                    errorMessage = response.message || errorMessage;
                } catch (e) {
                    // Use default message
                }
                alert(errorMessage);
                $('#scheduler-interval').text(originalText);
            }
        });
    }).fail(function() {
        // If status API fails, continue with DOM value
        const currentInterval = $('#scheduler-interval').text() || '30';
        console.warn('Could not fetch current scheduler status, using DOM value:', currentInterval);
        
        // Continue with the original logic using DOM value
        const minutes = prompt(`Enter forwarding interval in minutes (current: ${currentInterval}):`, currentInterval);
        // ... rest of the logic would be the same
        if (minutes !== null && !isNaN(minutes) && parseInt(minutes) >= 1 && parseInt(minutes) <= 10080) {
            const intervalMinutes = parseInt(minutes);
            
            $.ajax({
                url: '/api/scheduler/update',
                method: 'POST',
                data: JSON.stringify({minutes: intervalMinutes}),
                contentType: 'application/json',
                success: function(response) {
                    if (response.success) {
                        alert(`Interval updated successfully to ${intervalMinutes} minutes!`);
                        location.reload();
                    } else {
                        alert(`Failed to update interval: ${response.message || 'Unknown error'}`);
                    }
                },
                error: function(xhr) {
                    alert('Failed to update interval');
                }
            });
        }
    });
}

// Update scheduler UI based on status
function updateSchedulerUI(status) {
    const $btn = $('#scheduler-toggle-btn');
    const $icon = $('#scheduler-toggle-icon');
    const $text = $('#scheduler-toggle-text');
    const $badge = $('#scheduler-status-badge');
    
    if (status.is_paused) {
        // Scheduler is paused
        $btn.removeClass('btn-warning').addClass('btn-success');
        $icon.removeClass('bi-pause-fill').addClass('bi-play-fill');
        $text.text('Resume');
        $badge.removeClass('bg-success bg-warning').addClass('bg-secondary');
        $badge.text('Paused');
    } else if (status.job_running) {
        // Job is currently running
        $btn.removeClass('btn-success').addClass('btn-warning');
        $icon.removeClass('bi-play-fill').addClass('bi-pause-fill');
        $text.text('Pause');
        $badge.removeClass('bg-success bg-secondary').addClass('bg-warning');
        $badge.text('Running');
    } else {
        // Scheduler is active (not paused, not running)
        $btn.removeClass('btn-success').addClass('btn-warning');
        $icon.removeClass('bi-play-fill').addClass('bi-pause-fill');
        $text.text('Pause');
        $badge.removeClass('bg-secondary bg-warning').addClass('bg-success');
        $badge.text('Active');
    }
    
    // Update interval display
    if (status.interval_minutes) {
        $('#scheduler-interval').text(status.interval_minutes);
    }
    
    // Update next run time if available
    if (status.next_run_time && !status.is_paused) {
        const nextRun = new Date(status.next_run_time);
        const formatted = nextRun.toLocaleDateString() + ' ' + nextRun.toLocaleTimeString();
        $('#scheduler-next-run').text(formatted);
        updateNextRun(); // Update the countdown
    } else if (status.is_paused) {
        $('#scheduler-next-run').text('Paused');
        $('#next-run').text('Paused');
    } else {
        $('#scheduler-next-run').text('N/A');
        $('#next-run').text('N/A');
    }
}

// Refresh scheduler status
function refreshSchedulerStatus() {
    // Don't refresh if currently toggling
    if (schedulerState.isToggling) {
        return;
    }
    
    $.get('/api/scheduler/status', function(response) {
        if (response.success && response.status) {
            const status = response.status;
            
            // Store the current status
            schedulerState.currentStatus = status;
            
            // Update UI
            updateSchedulerUI(status);
            
            // Enable the toggle button if it was disabled
            $('#scheduler-toggle-btn').prop('disabled', false);
        }
    }).fail(function() {
        console.warn('Failed to refresh scheduler status');
        // Try to enable the button anyway
        $('#scheduler-toggle-btn').prop('disabled', false);
    });
}

// Update next run time
function updateNextRun() {
    const nextRun = $('#scheduler-next-run').text();
    if (nextRun && nextRun !== 'N/A') {
        const nextRunDate = new Date(nextRun);
        const now = new Date();
        const diff = nextRunDate - now;
        
        if (diff > 0) {
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            
            if (hours > 0) {
                $('#next-run').text(`${hours}h ${mins}m`);
            } else {
                $('#next-run').text(`${mins}m`);
            }
        } else {
            $('#next-run').text('Soon');
        }
    }
}

// Initialize
$(document).ready(function() {
    // Load stats and initialize scheduler status immediately
    loadStats();
    refreshSchedulerStatus(); // Load current scheduler status first
    
    // Set up periodic updates
    setInterval(function() {
        // Only update if not currently toggling
        if (!schedulerState.isToggling) {
            updateNextRun();
            refreshSchedulerStatus();
        }
    }, 30000); // Update every 30 seconds
    
    // Also refresh on window focus (when user returns to tab)
    $(window).on('focus', function() {
        if (!schedulerState.isToggling) {
            refreshSchedulerStatus();
        }
    });
    
    // Prevent accidental double-clicks on all buttons
    $('button').on('click', function(e) {
        const $this = $(this);
        if ($this.data('clicked')) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
        $this.data('clicked', true);
        setTimeout(function() {
            $this.data('clicked', false);
        }, 1000);
    });
});
</script>
{% endblock %} 